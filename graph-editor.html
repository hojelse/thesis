<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Graph Editor</title>
	<style>
		svg {
			border: 1px solid black;
		}
	</style>
</head>
<body>
	<svg viewBox="0 0 100 100">
		<g id="edges_container"></g>
		<g id="vertices_container"></g>
	</svg>
	<input id="edit-mode" type="checkbox">
	<label for="edit-mode"></label>
	<script>
		const svg = document.querySelector("svg");
		const edges_container = document.querySelector("#edges_container");
		const vertices_container = document.querySelector("#vertices_container");
		const editModeToggle = document.querySelector("input");
		const label = document.querySelector("label[for=edit-mode]");

		class Graph {
			n = 0;
			next_vertex_id = 0;
			adj = {}
			embedding = {}

			constructor() {

			}

			addVertex(x, y) {
				this.adj[this.next_vertex_id] = new Set();
				this.embedding[this.next_vertex_id] = {x, y};
				this.n++;
				this.next_vertex_id++;
				// this.print();
				return this.n-1;
			}

			removeVertex(id) {
				delete this.adj[id];

				// delete all incident edges
				for (const [id2, v] of Object.entries(this.adj)) {
					v.delete(id);
				}

				delete this.embedding[id];
				this.n--;
				// this.print();
			}

			addEdge(u, v) {
				this.adj[u].add(v);
				this.adj[v].add(u);
				// this.print();
			}

			removeEdge(u, v) {
				this.adj[u].delete(v);
				this.adj[v].delete(u);
				// this.print();
			}

			print() {
				let str = `${this.n}\n`;
				for (const s in this.embedding) {
					str += `${s}: ${this.embedding[s].x} ${this.embedding[s].y}\n`;
				}
				for (const s in this.adj) {
					str += `${s}:`;
					for (const v of this.adj[s]) {
						str += ` ${v}`;
					}
					str += "\n";
				}

				str += document.querySelector("svg").outerHTML;
				console.log(str)
			}
		}

		const g = new Graph();

		label.innerText = (editModeToggle.checked) ? "edge" : "vertex";
		editModeToggle.onchange = () => {
			label.innerText = (editModeToggle.checked) ? "edge" : "vertex";
		}

		let from = null

		let edge_factory = null;

		svg.addEventListener("pointerup", evt => {
			if (editModeToggle.checked) {
				from = null
			}
		})

		let vertex_id_counter = 0;

		svg.addEventListener("pointermove", evt => {
			if (!from) return;
			edge_factory.setAttribute("x1", `${from.cx.baseVal.value}`);
			edge_factory.setAttribute("y1", `${from.cy.baseVal.value}`);
			edge_factory.setAttribute("x2", `${(evt.offsetX / svg.clientWidth) * 100}`);
			edge_factory.setAttribute("y2", `${(evt.offsetY / svg.clientHeight) * 100}`);
		})

		svg.addEventListener("pointerup", evt => {
			if (edge_factory)
				svg.removeChild(document.querySelector("#edge-factory"));
		});

		function incident_edges(id) {
			const edges = [];
			for (let i = 0; i < g.next_vertex_id; i++) {
				let el = document.querySelector(`#edge-${i}-${id}`);
				if (el) edges.push(el);
			}
			document.querySelectorAll(`[id^="edge-${id}`).forEach(el => {
				if (el) edges.push(el);
			})

			return edges;
		}

		svg.addEventListener("click", (evt) => {
			if (editModeToggle.checked) return;

			const x = (evt.offsetX / svg.clientWidth) * 100;
			const y = (evt.offsetY / svg.clientHeight) * 100;
			const i = g.addVertex(x, y);

			const vertex = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			vertex.setAttribute("id", `vertex-${i}`);
			vertex.setAttribute("r", 1);
			vertex.setAttribute("cx", x);
			vertex.setAttribute("cy", y);
			vertex.setAttribute("id", `vertex-${vertex_id_counter}`);

			vertex.addEventListener("pointerup", (evt) => {
				if (editModeToggle.checked) return;
				evt.stopPropagation();
				const id = parseInt(evt.target.id.split("-")[1]);
				g.removeVertex(id);
				
				for (const el of incident_edges(id))
					edges_container.removeChild(el);

				vertices_container.removeChild(evt.srcElement);
			})

			vertex.addEventListener("pointerdown", evt => {
				if (!editModeToggle.checked) return;
				from = evt.target;
				edge_factory = document.createElementNS("http://www.w3.org/2000/svg", "line");
				edge_factory.setAttribute("id", "edge-factory");
				edge_factory.setAttribute("pointer-events", "none");
				edge_factory.setAttribute("stroke", `black`);
				svg.appendChild(edge_factory);
			})

			vertex.addEventListener("pointerup", evt => {
				if (editModeToggle.checked) {
					if (!from) return;

					const from_id = parseInt(from.id.split("-")[1]);
					const to_id = parseInt(evt.target.id.split("-")[1]);
					g.addEdge(from_id, to_id);

					const edge = document.createElementNS("http://www.w3.org/2000/svg", "line");
					edge.setAttribute("id", `edge-${from_id}-${to_id}`)
					edge.setAttribute("x1", `${from.cx.baseVal.value}`);
					edge.setAttribute("y1", `${from.cy.baseVal.value}`);
					edge.setAttribute("x2", `${evt.target.cx.baseVal.value}`);
					edge.setAttribute("y2", `${evt.target.cy.baseVal.value}`);
					edge.setAttribute("stroke", `black`);
					edges_container.appendChild(edge);

					edge.addEventListener("click", evt => {
						if (!editModeToggle.checked) return;
						evt.stopPropagation();

						const [from_id, to_id] = evt.target.id.split("-")[1].split("-").map(x => parseInt(x));
						g.removeEdge(from_id, to_id);
						edges_container.removeChild(evt.target);
					})
				}
			})

			vertex_id_counter++;
			vertices_container.appendChild(vertex);
		})
	</script>
</body>
</html>